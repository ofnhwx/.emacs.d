#+TITLE: user-init.org
#+STARTUP: overview

* 通常の設定
** フォントの設定
   #+BEGIN_SRC emacs-lisp
     (add-hook 'window-setup-hook 'e:setup-font)
   #+END_SRC

** ファイルを移動
*** プライベート
    #+BEGIN_SRC emacs-lisp
      (set-variable 'custom-file (expand-file-name "custom.el" e:private-directory))
      (set-variable 'auth-sources `(,(expand-file-name "authinfo.plist" e:private-directory)))
      (set-variable 'spacemacs-env-vars-file (expand-file-name "spacemacs.env" e:private-directory))
    #+END_SRC

*** キャッシュ
    #+BEGIN_SRC emacs-lisp
      (set-variable 'forge-database-file (expand-file-name "forge-database.sqlite" spacemacs-cache-directory))
      (set-variable 'lsp-session-file (expand-file-name "lsp-session-v1" spacemacs-cache-directory))
      (set-variable 'magithub-dir (expand-file-name "magithub" spacemacs-cache-directory))
      (set-variable 'transient-history-file (expand-file-name "transient/history.el" spacemacs-cache-directory))
      (set-variable 'transient-levels-file (expand-file-name "transient/levels.el" spacemacs-cache-directory))
      (set-variable 'transient-values-file (expand-file-name "transient/values.el" spacemacs-cache-directory))
      (set-variable 'url-cache-directory (expand-file-name "url/cache" spacemacs-cache-directory))
      (set-variable 'url-cookie-file (expand-file-name "url/cookies" spacemacs-cache-directory))
    #+END_SRC

** 「Viperize?」の確認をしない
   #+BEGIN_SRC emacs-lisp
     (set-variable 'viper-mode nil)
   #+END_SRC

** shellの設定
   #+BEGIN_SRC emacs-lisp
     (set-variable 'shell-file-name
                   (or (executable-find "zsh")
                       (executable-find "bash")
                       (executable-find "sh")))
   #+END_SRC

** パスワード関連
   #+BEGIN_SRC emacs-lisp
     (set-variable 'password-cache-expiry 3600)
     (set-variable 'plstore-encoded t)
   #+END_SRC

** 折り返さない
   #+BEGIN_SRC emacs-lisp
     (setq-default truncate-lines t)
     (set-variable 'truncate-partial-width-windows nil)
   #+END_SRC

** 最終行の改行は`EditorConfig'で管理
   #+BEGIN_SRC emacs-lisp
     (set-variable 'mode-require-final-newline nil)
     (set-variable 'require-final-newline nil)
   #+END_SRC

** ロックファイルを作成しない
   #+BEGIN_SRC emacs-lisp
     (set-variable 'create-lockfiles nil)
   #+END_SRC

** 右から左に読む言語に対応しない
   #+BEGIN_SRC emacs-lisp
     (setq-default bidi-display-reordering nil)
   #+END_SRC

** ヘッダーラインの設定
   #+BEGIN_SRC emacs-lisp
     (defun e:setup-headerline-for-files ()
       "ファイル名をヘッダーラインにいい感じに表示する"
       (let* ((path (or buffer-file-name "/path/to/filename.test"))
              (dir  (file-name-directory path))
              (file (file-name-nondirectory path))
              (max  (- (window-width) (length file))))
         (setq-local header-line-format
                     (concat
                      (propertize " " 'display '(space :align-to 0))
                      (propertize (e:shorten dir max))
                      (propertize file 'face '(:foreground "#ff0000")))))
       (setq-local spaceline-buffer-id-p nil))

     ;; ファイルを開く際に実行
     (add-hook 'find-file-hook 'e:setup-headerline-for-files)
   #+END_SRC

* パッケージ毎の設定
** ace-window
   #+BEGIN_SRC emacs-lisp
     (spacemacs|use-package-add-hook ace-window
       :post-init
       (bind-keys
        :map global-map
        ("C-^" . ace-window))
       (set-variable 'aw-keys (number-sequence ?1 ?9)))
   #+END_SRC

** avy
   #+BEGIN_SRC emacs-lisp
     (spacemacs|use-package-add-hook avy
       :post-config
       (setq avy-keys (number-sequence ?a ?z))
       (setq avy-all-windows t))
   #+END_SRC

** ddskk
   #+BEGIN_SRC emacs-lisp
     (spacemacs|use-package-add-hook ddskk
       :post-init
       (set-variable 'default-input-method "japanese-skk")
       (progn
         (set-variable 'skk-user-directory (expand-file-name "ddskk" e:private-directory))
         (set-variable 'skk-large-jisyo (expand-file-name "dic-mirror/SKK-JISYO.L" e:external-directory)))
       (progn
         (set-variable 'skk-preload t)
         (set-variable 'skk-egg-like-newline t)
         (set-variable 'skk-share-private-jisyo t)
         (set-variable 'skk-show-annotation t)
         (set-variable 'skk-show-inline 'vertical)
         (set-variable 'skk-sticky-key ";")
         (set-variable 'skk-use-jisx0201-input-method t))
       (when (executable-find "google-ime-skk")
         (set-variable 'skk-server-prog (executable-find "google-ime-skk"))
         (set-variable 'skk-server-inhibit-startup-server t)
         (set-variable 'skk-server-host "127.0.0.1")
         (set-variable 'skk-server-portnum 55100)))
   #+END_SRC

** emmet-mode
   #+BEGIN_SRC emacs-lisp
     (spacemacs|use-package-add-hook emmet-mode
       :post-config
       ;; ddskk と相性が悪いので調整
       (bind-keys
        :map emmet-mode-keymap
        ("<C-return>" . nil)
        ("C-c C-j" . emmet-expand-line)
        ("C-j" . nil)))
   #+END_SRC

** eshell
   #+BEGIN_SRC emacs-lisp
     (spacemacs|use-package-add-hook eshell
       :post-init
       (set-variable 'eshell-history-size 100000))
   #+END_SRC

** flycheck
   #+BEGIN_SRC emacs-lisp
     (spacemacs|use-package-add-hook flycheck
       :post-init
       (set-variable 'flycheck-idle-buffer-switch-delay 3.0)
       (set-variable 'flycheck-idle-change-delay 3.0))
   #+END_SRC

** google-translate
   #+BEGIN_SRC emacs-lisp
     (spacemacs|use-package-add-hook google-translate
       :post-init
       (set-variable 'google-translate-default-source-language nil)
       (set-variable 'google-translate-default-target-language "ja"))
   #+END_SRC

** helm
   #+BEGIN_SRC emacs-lisp
     (spacemacs|use-package-add-hook helm
       :post-init
       (bind-key [remap eval-expression] 'helm-eval-expression)
       (with-eval-after-load 'eldoc-eval
         (bind-key [remap eldoc-eval-expression] 'helm-eval-expression eldoc-in-minibuffer-mode-map)))
   #+END_SRC

** magit
   #+BEGIN_SRC emacs-lisp
     (spacemacs|use-package-add-hook magit
       :post-init
       (set-variable 'magit-log-margin '(t "%Y-%m-%d %H:%M" magit-log-margin-width t 15))
       (set-variable 'magit-diff-refine-hunk 'all)
       (set-variable 'smerge-refine-ignore-whitespace nil))
   #+END_SRC

** notmuch
   #+BEGIN_SRC emacs-lisp
     (spacemacs|use-package-add-hook notmuch
       :post-init
       (set-variable 'notmuch-archive-tags '("-inbox" "-unread"))
       (set-variable 'notmuch-column-control 1.0)
       (set-variable 'notmuch-hello-thousands-separator ",")
       (set-variable 'notmuch-search-oldest-first nil)
       (set-variable 'notmuch-show-empty-saved-searches t)
       (set-variable 'notmuch-show-logo nil)
       (set-variable 'notmuch-hello-hide-tags
                     '("encrypted" "drafts" "flagged" "inbox" "sent" "signed" "spam" "unread"))
       (set-variable 'notmuch-saved-searches
                     '((:name "受信トレイ" :query "tag:inbox"   :key "i")
                       (:name "未読　　　" :query "tag:unread"  :key "u")
                       (:name "スター付き" :query "tag:flagged" :key "f")
                       (:name "送信済み　" :query "tag:sent"    :key "t")
                       (:name "下書き　　" :query "tag:draft"   :key "d")
                       (:name "すべて　　" :query "*"           :key "a")
                       (:name "迷惑メール" :query "tag:spam"    :key "s")))
       (setenv "XAPIAN_CJK_NGRAM" "1"))
   #+END_SRC

** org
   #+BEGIN_SRC emacs-lisp
     (spacemacs|use-package-add-hook org
       :post-init
       (set-variable 'org-directory (expand-file-name "org" e:private-directory))
       (let ((org-agenda-directory (expand-file-name "agenda" org-directory)))
         (when (file-directory-p org-agenda-directory)
           (set-variable 'org-agenda-files (cl-remove-if 'file-directory-p (directory-files org-agenda-directory t))))))
   #+END_SRC

** php-mode
   #+BEGIN_SRC emacs-lisp
     (spacemacs|use-package-add-hook php-mode
       :post-init
       (spacemacs|add-company-backends
         :modes php-mode))
   #+END_SRC

** prodigy
   #+BEGIN_SRC emacs-lisp
     (spacemacs|use-package-add-hook prodigy
       :post-init
       (defun e:prodigy-start-service (name)
         (let ((service (prodigy-find-service name)))
           (when service
             (prodigy-start-service service)))))
   #+END_SRC

** recentf
   #+BEGIN_SRC emacs-lisp
     (spacemacs|use-package-add-hook recentf
       :post-init
       (set-variable 'recentf-max-menu-items 20)
       (set-variable 'recentf-max-saved-items 3000)
       (set-variable 'recentf-filename-handlers '(abbreviate-file-name))
       :post-config
       (progn
         (defun e:recentf-save-list:before (&rest args)
           (let ((list nil))
             (dolist (file (mapcar 'abbreviate-file-name recentf-list))
               (or (member file list)
                   (push file list)))
             (setq recentf-list (reverse list))))
         (advice-add 'recentf-save-list :before 'e:recentf-save-list:before)))
   #+END_SRC